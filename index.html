<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DonutSMP Player Market</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0 40px rgba(0, 123, 255, 0.3);
            animation: fadeIn 0.8s ease;
        }

        h1 {
            font-size: 3em;
            background: linear-gradient(90deg, #00d4ff, #0066ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 123, 255, 0.5);
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 10px rgba(0, 123, 255, 0.5)); }
            to { filter: drop-shadow(0 0 20px rgba(0, 123, 255, 0.8)); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-section, .main-content {
            display: none;
        }

        .login-section.active, .main-content.active {
            display: block;
        }

        .login-box {
            background: rgba(0, 0, 0, 0.7);
            padding: 40px;
            border-radius: 15px;
            max-width: 400px;
            margin: 50px auto;
            border: 2px solid rgba(0, 123, 255, 0.3);
            box-shadow: 0 0 40px rgba(0, 123, 255, 0.2);
            animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input, textarea, button, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid rgba(0, 123, 255, 0.5);
            background: rgba(0, 20, 40, 0.8);
            color: #fff;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        }

        button {
            background: linear-gradient(135deg, #0066ff, #00d4ff);
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 123, 255, 0.6);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid rgba(0, 123, 255, 0.3);
        }

        .player-head {
            width: 50px;
            height: 50px;
            image-rendering: pixelated;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
            background: rgba(0, 123, 255, 0.2);
        }

        .player-head-fallback {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            background: linear-gradient(135deg, #0066ff, #00d4ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(0, 123, 255, 0.3);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 123, 255, 0.4);
            border-color: #00d4ff;
        }

        .offer-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .offer-header .player-head {
            width: 40px;
            height: 40px;
        }

        .offer-type {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .type-item { background: rgba(0, 200, 100, 0.3); border: 1px solid #00c864; }
        .type-service { background: rgba(255, 150, 0, 0.3); border: 1px solid #ff9600; }
        .type-farm { background: rgba(200, 0, 255, 0.3); border: 1px solid #c800ff; }

        .chat-section {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid rgba(0, 123, 255, 0.3);
            margin-top: 20px;
        }

        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .chat-message .player-head {
            width: 30px;
            height: 30px;
        }

        .chat-content {
            flex: 1;
        }

        .chat-username {
            color: #00d4ff;
            font-weight: bold;
            font-size: 14px;
        }

        .chat-text {
            color: #ccc;
            font-size: 14px;
            margin-top: 3px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            border: 2px solid rgba(0, 123, 255, 0.5);
            box-shadow: 0 0 50px rgba(0, 123, 255, 0.5);
            animation: scaleIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .logout-btn {
            background: rgba(255, 0, 0, 0.3);
            border: 1px solid #ff0000;
            padding: 8px 16px;
            width: auto;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 123, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab:hover {
            border-color: #00d4ff;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #0066ff, #00d4ff);
            border-color: #00d4ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stars {
            color: #ffd700;
            font-size: 20px;
            margin: 10px 0;
        }

        .star {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .star:hover {
            transform: scale(1.2);
        }

        .vouch-card {
            background: rgba(0, 100, 50, 0.2);
            border: 2px solid rgba(0, 200, 100, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .scam-card {
            background: rgba(150, 0, 0, 0.2);
            border: 2px solid rgba(255, 50, 50, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .rating-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .warning-icon {
            color: #ff3333;
            font-size: 20px;
        }

        #loginError {
            color: #ff6666;
            margin-top: 15px;
            font-size: 14px;
            display: none;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DonutSMP Player Market</h1>
            <p>Trade Items, Services & Farms</p>
        </header>

        <div class="login-section active">
            <div class="login-box">
                <h2 style="margin-bottom: 20px; color: #00d4ff;">Enter Your Minecraft Username</h2>
                <input type="text" id="minecraftUsername" placeholder="Your Minecraft Username" />
                <button id="loginButton" onclick="doLogin()">Enter Market</button>
                <p id="loginError">Invalid Minecraft username. Please try again.</p>
            </div>
        </div>

        <div class="main-content">
            <div class="user-info">
                <img id="userHead" class="player-head" src="" alt="Player Head">
                <div style="flex: 1;">
                    <strong id="displayUsername"></strong>
                    <div style="font-size: 12px; color: #888;">Logged In</div>
                </div>
                <button class="logout-btn" onclick="window.logout()">Logout</button>
                <button onclick="window.openCreateModal()">Create Offer</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="window.switchTab('offers')">Active Offers</div>
                <div class="tab" onclick="window.switchTab('vouches')">Vouches & Ratings</div>
                <div class="tab" onclick="window.switchTab('scams')">‚ö†Ô∏è Scam Reports</div>
            </div>

            <div class="tab-content active" id="offersTab">
                <h2 style="margin: 30px 0 15px 0;">Active Offers</h2>
                <div class="grid" id="offersGrid"></div>
            </div>

            <div class="tab-content" id="vouchesTab">
                <h2 style="margin: 30px 0 15px 0;">Player Vouches & Ratings</h2>
                <input type="text" id="vouchSearch" placeholder="Search for a player..." oninput="window.searchVouches()" style="max-width: 400px; margin-bottom: 20px;" />
                <div id="vouchesGrid"></div>
            </div>

            <div class="tab-content" id="scamsTab">
                <h2 style="margin: 30px 0 15px 0;">Scam Reports</h2>
                <button onclick="window.openScamReportModal()" style="margin-bottom: 20px;">Report a Scammer</button>
                <div id="scamReports"></div>
            </div>

            <div class="chat-section">
                <h3 style="margin-bottom: 15px;">Global Chat</h3>
                <div class="chat-messages" id="chatMessages"></div>
                <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') window.sendMessage()" />
                <button onclick="window.sendMessage()">Send</button>
            </div>
        </div>

        <div class="modal" id="createModal">
            <div class="modal-content">
                <h2 style="margin-bottom: 20px;">Create New Offer</h2>
                <select id="offerType">
                    <option value="item">Item</option>
                    <option value="service">Service</option>
                    <option value="farm">Farm</option>
                </select>
                <input type="text" id="offerTitle" placeholder="Title" />
                <textarea id="offerDescription" placeholder="Description" rows="4"></textarea>
                <input type="text" id="offerPrice" placeholder="Price (e.g., 1m/1,000,000)" />
                <button onclick="window.createOffer()">Create Offer</button>
                <button onclick="window.closeCreateModal()" style="background: rgba(100,100,100,0.5); margin-top: 10px;">Cancel</button>
            </div>
        </div>

        <div class="modal" id="offerModal">
            <div class="modal-content">
                <div id="offerDetails"></div>
                <div id="sellerRating"></div>
                <h3 style="margin: 20px 0 10px 0;">Chat with Seller</h3>
                <div class="chat-messages" id="offerChat" style="max-height: 200px;"></div>
                <input type="text" id="offerChatInput" placeholder="Message seller..." onkeypress="if(event.key==='Enter') window.sendOfferMessage()" />
                <button onclick="window.sendOfferMessage()">Send</button>
                <button onclick="window.openVouchModal()" style="background: rgba(0, 200, 100, 0.5); margin-top: 10px;">‚úì Vouch for Seller</button>
                <button onclick="window.closeOfferModal()" style="background: rgba(100,100,100,0.5); margin-top: 10px;">Close</button>
            </div>
        </div>

        <div class="modal" id="vouchModal">
            <div class="modal-content">
                <h2 style="margin-bottom: 20px;">Vouch for <span id="vouchUsername"></span></h2>
                <div class="stars" id="ratingStars">
                    <span class="star" onclick="window.setRating(1)">‚òÜ</span>
                    <span class="star" onclick="window.setRating(2)">‚òÜ</span>
                    <span class="star" onclick="window.setRating(3)">‚òÜ</span>
                    <span class="star" onclick="window.setRating(4)">‚òÜ</span>
                    <span class="star" onclick="window.setRating(5)">‚òÜ</span>
                </div>
                <p style="color: #888; font-size: 14px;">Click the stars to rate (1-5)</p>
                <textarea id="vouchComment" placeholder="Leave a comment about your experience..." rows="4"></textarea>
                <button onclick="window.submitVouch()">Submit Vouch</button>
                <button onclick="window.closeVouchModal()" style="background: rgba(100,100,100,0.5); margin-top: 10px;">Cancel</button>
            </div>
        </div>

        <div class="modal" id="scamModal">
            <div class="modal-content">
                <h2 style="margin-bottom: 20px;">Report a Scammer</h2>
                <input type="text" id="scammerUsername" placeholder="Scammer's Minecraft Username" />
                <input type="text" id="scamItem" placeholder="What did they scam? (e.g., Diamond Sword, 5000 coins)" />
                <textarea id="scamDescription" placeholder="Describe what happened..." rows="4"></textarea>
                <p style="color: #ff6666; font-size: 14px; margin-top: 10px;">‚ö†Ô∏è False reports may result in consequences</p>
                <button onclick="window.submitScamReport()">Submit Report</button>
                <button onclick="window.closeScamReportModal()" style="background: rgba(100,100,100,0.5); margin-top: 10px;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentOfferId = null;
        let currentSellerUsername = null;
        let selectedRating = 0;

        async function doLogin() {
            const usernameInput = document.getElementById('minecraftUsername');
            const username = usernameInput.value.trim();
            const loginButton = document.getElementById('loginButton');
            const errorMsg = document.getElementById('loginError');

            if (!username) {
                alert('Please enter a Minecraft username');
                return;
            }

            loginButton.disabled = true;
            loginButton.textContent = 'Checking...';
            errorMsg.style.display = 'none';

            try {
                // Reliable Mojang/Microsoft API endpoint (works in 2026)
                const response = await fetch(`https://api.minecraftservices.com/minecraft/profile/lookup/name/${username}`);

                if (response.ok) {
                    localStorage.setItem('minecraftUsername', username);

                    document.querySelector('.login-section').classList.remove('active');
                    document.querySelector('.main-content').classList.add('active');

                    document.getElementById('displayUsername').textContent = username;

                    const headImg = document.getElementById('userHead');
                    headImg.onerror = function() {
                        this.style.display = 'none';
                        const fallback = document.createElement('div');
                        fallback.className = 'player-head-fallback';
                        fallback.textContent = username.charAt(0).toUpperCase();
                        this.parentNode.insertBefore(fallback, this);
                    };
                    headImg.src = `https://mc-heads.net/avatar/${username}/50`;

                    setTimeout(() => {
                        if (window.loadOffers) window.loadOffers();
                        if (window.loadChat) window.loadChat();
                        if (window.loadVouches) window.loadVouches();
                        if (window.loadScamReports) window.loadScamReports();
                    }, 1000);
                } else {
                    errorMsg.style.display = 'block';
                    usernameInput.focus();
                    usernameInput.select();
                }
            } catch (err) {
                alert('Network error. Please check your connection and try again.');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Enter Market';
            }
        }

        window.logout = function() {
            localStorage.removeItem('minecraftUsername');
            location.reload();
        };

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        };

        window.searchVouches = function() {
            const search = document.getElementById('vouchSearch').value.toLowerCase();
            const cards = document.querySelectorAll('#vouchesGrid .card');
            cards.forEach(card => {
                const username = card.querySelector('strong').textContent.toLowerCase();
                card.style.display = username.includes(search) ? 'block' : 'none';
            });
        };

        window.openCreateModal = function() {
            document.getElementById('createModal').classList.add('active');
        };

        window.closeCreateModal = function() {
            document.getElementById('createModal').classList.remove('active');
        };

        window.openOffer = function(offerId, offer) {
            window.currentOfferId = offerId;
            window.currentSellerUsername = offer.username;
            const modal = document.getElementById('offerModal');
            modal.classList.add('active');
            
            document.getElementById('offerDetails').innerHTML = `
                <div class="offer-header">
                    <img class="player-head" src="https://mc-heads.net/avatar/${offer.username}/40" onerror="this.style.display='none'; const d=document.createElement('div'); d.className='player-head-fallback'; d.style.width='40px'; d.style.height='40px'; d.style.fontSize='16px'; d.textContent='${offer.username.charAt(0).toUpperCase()}'; this.parentNode.insertBefore(d, this);" alt="${offer.username}">
                    <strong>${offer.username}</strong>
                </div>
                <div class="offer-type type-${offer.type}">${offer.type.toUpperCase()}</div>
                <h3>${offer.title}</h3>
                <p style="margin: 15px 0;">${offer.description}</p>
                <p style="color: #00d4ff; font-weight: bold; font-size: 18px;">üí∞ ${offer.price}</p>
            `;

            window.loadSellerRating(offer.username);
            window.loadOfferChat(offerId);
        };

        window.closeOfferModal = function() {
            document.getElementById('offerModal').classList.remove('active');
            window.currentOfferId = null;
            window.currentSellerUsername = null;
        };

        window.openVouchModal = function() {
            if (!window.currentSellerUsername) return;
            document.getElementById('vouchModal').classList.add('active');
            document.getElementById('vouchUsername').textContent = window.currentSellerUsername;
            window.selectedRating = 0;
            window.updateStarDisplay();
        };

        window.closeVouchModal = function() {
            document.getElementById('vouchModal').classList.remove('active');
            document.getElementById('vouchComment').value = '';
        };

        window.setRating = function(rating) {
            window.selectedRating = rating;
            window.updateStarDisplay();
        };

        window.updateStarDisplay = function() {
            const stars = document.querySelectorAll('#ratingStars .star');
            stars.forEach((star, index) => {
                star.textContent = index < window.selectedRating ? '‚òÖ' : '‚òÜ';
            });
        };

        window.openScamReportModal = function() {
            document.getElementById('scamModal').classList.add('active');
        };

        window.closeScamReportModal = function() {
            document.getElementById('scamModal').classList.remove('active');
            document.getElementById('scammerUsername').value = '';
            document.getElementById('scamItem').value = '';
            document.getElementById('scamDescription').value = '';
        };
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA8GnZIIPOv7IOL-s9Clcu4XKNj_zpWTYM",
            authDomain: "donutsmp-player-market.firebaseapp.com",
            projectId: "donutsmp-player-market",
            storageBucket: "donutsmp-player-market.firebasestorage.app",
            messagingSenderId: "383632880902",
            appId: "1:383632880902:web:0223093c58ed48f586da87",
            measurementId: "G-SE4WLPRTYZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.onSnapshot = onSnapshot;
        window.orderBy = orderBy;
        window.limit = limit;
        window.getDocs = getDocs;

        window.createOffer = async function() {
            const username = localStorage.getItem('minecraftUsername');
            const type = document.getElementById('offerType').value;
            const title = document.getElementById('offerTitle').value.trim();
            const description = document.getElementById('offerDescription').value.trim();
            const price = document.getElementById('offerPrice').value.trim();

            if (!title || !description || !price) {
                alert('Please fill in all fields');
                return;
            }

            await addDoc(collection(db, 'offers'), {
                username,
                type,
                title,
                description,
                price,
                timestamp: Date.now()
            });

            document.getElementById('offerTitle').value = '';
            document.getElementById('offerDescription').value = '';
            document.getElementById('offerPrice').value = '';
            window.closeCreateModal();
        };

        window.sendMessage = async function() {
            const username = localStorage.getItem('minecraftUsername');
            const message = document.getElementById('chatInput').value.trim();
            
            if (!message) return;

            await addDoc(collection(db, 'chat'), {
                username,
                message,
                timestamp: Date.now()
            });

            document.getElementById('chatInput').value = '';
        };

        window.sendOfferMessage = async function() {
            if (!window.currentOfferId) return;
            
            const username = localStorage.getItem('minecraftUsername');
            const message = document.getElementById('offerChatInput').value.trim();
            
            if (!message) return;

            await addDoc(collection(db, `offers/${window.currentOfferId}/chat`), {
                username,
                message,
                timestamp: Date.now()
            });

            document.getElementById('offerChatInput').value = '';
        };

        window.submitVouch = async function() {
            if (window.selectedRating === 0) {
                alert('Please select a rating');
                return;
            }

            const username = localStorage.getItem('minecraftUsername');
            const comment = document.getElementById('vouchComment').value.trim();

            if (!comment) {
                alert('Please leave a comment');
                return;
            }

            await addDoc(collection(db, 'vouches'), {
                buyerUsername: username,
                sellerUsername: window.currentSellerUsername,
                rating: window.selectedRating,
                comment: comment,
                timestamp: Date.now()
            });

            window.closeVouchModal();
            alert('Vouch submitted successfully!');
        };

        window.submitScamReport = async function() {
            const username = localStorage.getItem('minecraftUsername');
            const scammerUsername = document.getElementById('scammerUsername').value.trim();
            const itemScammed = document.getElementById('scamItem').value.trim();
            const description = document.getElementById('scamDescription').value.trim();

            if (!scammerUsername || !itemScammed || !description) {
                alert('Please fill in all fields');
                return;
            }

            if (scammerUsername.toLowerCase() === username.toLowerCase()) {
                alert('You cannot report yourself');
                return;
            }

            await addDoc(collection(db, 'scams'), {
                reporterUsername: username,
                scammerUsername: scammerUsername,
                itemScammed: itemScammed,
                description: description,
                timestamp: Date.now()
            });

            window.closeScamReportModal();
            alert('Scam report submitted. Thank you for helping keep the community safe!');
        };

        window.loadOffers = function() {
            const q = query(collection(db, 'offers'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('offersGrid');
                grid.innerHTML = '';
                snapshot.forEach((doc) => {
                    const offer = doc.data();
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.cursor = 'pointer';
                    card.onclick = () => window.openOffer(doc.id, offer);
                    
                    card.innerHTML = `
                        <div class="offer-header">
                            <img class="player-head" src="https://mc-heads.net/avatar/${offer.username}/40" onerror="this.style.display='none'; const d=document.createElement('div'); d.className='player-head-fallback'; d.style.width='40px'; d.style.height='40px'; d.style.fontSize='16px'; d.textContent='${offer.username.charAt(0).toUpperCase()}'; this.parentNode.insertBefore(d, this);" alt="${offer.username}">
                            <strong>${offer.username}</strong>
                        </div>
                        <div class="offer-type type-${offer.type}">${offer.type.toUpperCase()}</div>
                        <h3>${offer.title}</h3>
                        <p style="color: #aaa; margin: 10px 0;">${offer.description}</p>
                        <p style="color: #00d4ff; font-weight: bold;">üí∞ ${offer.price}</p>
                        <div id="rating-${offer.username.replace(/[^a-zA-Z0-9]/g, '_')}" style="color: #ffd700; font-size: 14px; margin-top: 5px;">Loading rating...</div>
                    `;
                    grid.appendChild(card);
                    loadUserRating(offer.username, `rating-${offer.username.replace(/[^a-zA-Z0-9]/g, '_')}`);
                });
            });
        };

        async function loadUserRating(username, elementId) {
            const q = query(collection(db, 'vouches'), orderBy('timestamp', 'desc'));
            const snapshot = await getDocs(q);
            const vouches = [];
            snapshot.forEach((doc) => {
                const vouch = doc.data();
                if (vouch.sellerUsername === username) {
                    vouches.push(vouch.rating);
                }
            });
            
            const element = document.getElementById(elementId);
            if (element) {
                if (vouches.length > 0) {
                    const avg = (vouches.reduce((a, b) => a + b, 0) / vouches.length).toFixed(1);
                    const stars = '‚òÖ'.repeat(Math.round(avg)) + '‚òÜ'.repeat(5 - Math.round(avg));
                    element.innerHTML = `${stars} ${avg} (${vouches.length} reviews)`;
                } else {
                    element.innerHTML = 'No ratings yet';
                }
            }
        }

        window.loadSellerRating = async function(username) {
            const q = query(collection(db, 'vouches'), orderBy('timestamp', 'desc'));
            const snapshot = await getDocs(q);
            const vouches = [];
            snapshot.forEach((doc) => {
                const vouch = doc.data();
                if (vouch.sellerUsername === username) {
                    vouches.push(vouch);
                }
            });

            const ratingDiv = document.getElementById('sellerRating');
            if (vouches.length > 0) {
                const avg = (vouches.reduce((a, b) => a + b.rating, 0) / vouches.length).toFixed(1);
                const stars = '‚òÖ'.repeat(Math.round(avg)) + '‚òÜ'.repeat(5 - Math.round(avg));
                ratingDiv.innerHTML = `
                    <div class="rating-display" style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <span style="color: #ffd700; font-size: 18px;">${stars}</span>
                        <span>${avg}/5.0</span>
                        <span style="color: #888;">(${vouches.length} reviews)</span>
                    </div>
                `;
            } else {
                ratingDiv.innerHTML = '<p style="color: #888; margin: 10px 0;">No ratings yet</p>';
            }
        };

        window.loadOfferChat = function(offerId) {
            const q = query(
                collection(db, `offers/${offerId}/chat`),
                orderBy('timestamp', 'desc'),
                limit(30)
            );
            
            onSnapshot(q, (snapshot) => {
                const chatDiv = document.getElementById('offerChat');
                chatDiv.innerHTML = '';
                const messages = [];
                snapshot.forEach((doc) => messages.push(doc.data()));
                messages.reverse().forEach((msg) => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'chat-message';
                    msgDiv.innerHTML = `
                        <img class="player-head" src="https://mc-heads.net/avatar/${msg.username}/30" onerror="this.style.display='none'; const d=document.createElement('div'); d.className='player-head-fallback'; d.style.width='30px'; d.style.height='30px'; d.style.fontSize='14px'; d.textContent='${msg.username.charAt(0).toUpperCase()}'; this.parentNode.insertBefore(d, this);" alt="${msg.username}">
                        <div class="chat-content">
                            <div class="chat-username">${msg.username}</div>
                            <div class="chat-text">${msg.message}</div>
                        </div>
                    `;
                    chatDiv.appendChild(msgDiv);
                });
                chatDiv.scrollTop = chatDiv.scrollHeight;
            });
        };

        window.loadChat = function() {
            const q = query(collection(db, 'chat'), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(q, (snapshot) => {
                const chatDiv = document.getElementById('chatMessages');
                chatDiv.innerHTML = '';
                const messages = [];
                snapshot.forEach((doc) => messages.push(doc.data()));
                messages.reverse().forEach((msg) => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'chat-message';
                    msgDiv.innerHTML = `
                        <img class="player-head" src="https://mc-heads.net/avatar/${msg.username}/30" onerror="this.style.display='none'; const d=document.createElement('div'); d.className='player-head-fallback'; d.style.width='30px'; d.style.height='30px'; d.style.fontSize='14px'; d.textContent='${msg.username.charAt(0).toUpperCase()}'; this.parentNode.insertBefore(d, this);" alt="${msg.username}">
                        <div class="chat-content">
                            <div class="chat-username">${msg.username}</div>
                            <div class="chat-text">${msg.message}</div>
                        </div>
                    `;
                    chatDiv.appendChild(msgDiv);
                });
                chatDiv.scrollTop = chatDiv.scrollHeight;
            });
        };

        window.loadVouches = function() {
            const q = query(collection(db, 'vouches'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const vouchesData = {};
                snapshot.forEach((doc) => {
                    const vouch = doc.data();
                    if (!vouchesData[vouch.sellerUsername]) {
                        vouchesData[vouch.sellerUsername] = [];
                    }
                    vouchesData[vouch.sellerUsername].push(vouch);
                });

                const grid = document.getElementById('vouchesGrid');
                grid.innerHTML = '';

                for (const [username, vouches] of Object.entries(vouchesData)) {
                    const avgRating = (vouches.reduce((a, b) => a + b.rating, 0) / vouches.length).toFixed(1);
                    const stars = '‚òÖ'.repeat(Math.round(avgRating)) + '‚òÜ'.repeat(5 - Math.round(avgRating));

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="offer-header">
                            <img class="player-head" src="https://mc-heads.net/avatar/${username}/40" onerror="this.style.display='none'; const d=document.createElement('div'); d.className='player-head-fallback'; d.style.width='40px'; d.style.height='40px'; d.style.fontSize='16px'; d.textContent='${username.charAt(0).toUpperCase()}'; this.parentNode.insertBefore(d, this);" alt="${username}">
                            <strong>${username}</strong>
                        </div>
                        <div class="rating-display">
                            <span style="color: #ffd700; font-size: 20px;">${stars}</span>
                            <span style="color: #fff;">${avgRating}/5.0</span>
                            <span style="color: #888;">(${vouches.length} reviews)</span>
                        </div>
                        <div style="margin-top: 15px;">
                            ${vouches.slice(0, 3).map(v => `
                                <div class="vouch-card">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                                        <img class="player-head" style="width: 25px; height: 25px;" src="https://mc-heads.net/avatar/${v.buyerUsername}/25" onerror="this.style.display='none'; const d=document.createElement('div'); d.className='player-head-fallback'; d.style.width='25px'; d.style.height='25px'; d.style.fontSize='12px'; d.textContent='${v.buyerUsername.charAt(0).toUpperCase()}'; this.parentNode.insertBefore(d, this);" alt="${v.buyerUsername}">
                                        <strong style="font-size: 14px;">${v.buyerUsername}</strong>
                                        <span style="color: #ffd700; font-size: 14px;">${'‚òÖ'.repeat(v.rating)}${'‚òÜ'.repeat(5-v.rating)}</span>
                                    </div>
                                    <p style="color: #ccc; font-size: 14px;">${v.comment}</p>
                                </div>
                            `).join('')}
                            ${vouches.length > 3 ? `<p style="color: #888; font-size: 12px; margin-top: 10px;">+${vouches.length - 3} more reviews</p>` : ''}
                        </div>
                    `;
                    grid.appendChild(card);
                }
            });
        };

        window.loadScamReports = function() {
            const q = query(collection(db, 'scams'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const reportsDiv = document.getElementById('scamReports');
                reportsDiv.innerHTML = '';
                snapshot.forEach((doc) => {
                    const report = doc.data();
                    
                    const card = document.createElement('div');
                    card.className = 'scam-card';
                    card.innerHTML = `
                        <div style="display: flex; gap: 10px; align-items: start; margin-bottom: 10px;">
                            <span class="warning-icon">‚ö†Ô∏è</span>
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 8px;">
                                    <img class="player-head" style="width: 30px; height: 30px;" src="https://mc-heads.net/avatar/${report.scammerUsername}/30" onerror="this.style.display='none'; const d=document.createElement('div'); d.className='player-head-fallback'; d.style.width='30px'; d.style.height='30px'; d.style.fontSize='14px'; d.textContent='${report.scammerUsername.charAt(0).toUpperCase()}'; this.parentNode.insertBefore(d, this);" alt="${report.scammerUsername}">
                                    <strong style="color: #ff6666;">${report.scammerUsername}</strong>
                                    <span style="color: #888; font-size: 12px;">Reported by ${report.reporterUsername}</span>
                                </div>
                                <p style="color: #ffaa00; font-size: 14px; margin-bottom: 5px;"><strong>Scammed:</strong> ${report.itemScammed}</p>
                                <p style="color: #ccc; font-size: 14px;">${report.description}</p>
                                <p style="color: #666; font-size: 12px; margin-top: 8px;">${new Date(report.timestamp).toLocaleDateString()}</p>
                            </div>
                        </div>
                    `;
                    reportsDiv.appendChild(card);
                });
            });
        };

        const savedUsername = localStorage.getItem('minecraftUsername');
        if (savedUsername) {
            document.getElementById('minecraftUsername').value = savedUsername;
            doLogin();
        }
    </script>
</body>
</html>
